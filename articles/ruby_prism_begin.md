---
title: "Ruby 3.3ã§å°å…¥ã•ã‚ŒãŸPrismã‚’ä½¿ã†ã¨Rubyã®é–‹ç™ºä½“é¨“ãŒã©ã†å¤‰ã‚ã‚‹ã®ã‹"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## ã‚¿ã‚¤ãƒˆãƒ«å€™è£œ

- Ruby3.3ã§å°å…¥ã•ã‚ŒãŸPrismã‚’ä½¿ã†ã¨Rubyã®é–‹ç™ºä½“é¨“ãŒã©ã†å¤‰ã‚ã‚‹ã®ã‹
- æ–°ã—ã„Rubyãƒ‘ãƒ¼ã‚µãƒ¼Prismã‚’ä½¿ã†ã¨é–‹ç™ºä½“é¨“ãŒã©ã†å¤‰ã‚ã‚‹ã®ã‹
- å‹Ÿé›†ä¸­ã€‚ã€‚ã€‚


## ã“ã®è¨˜äº‹ã§æ‰±ã£ã¦ã„ã‚‹ã“ã¨

- Ruby 3.3ã§Prismã¨ã„ã†æ–°ã—ã„ãƒ‘ãƒ¼ã‚µãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ
- æœ¬è¨˜äº‹ã§ã¯Prismã®ã€Œãƒ‘ãƒ¼ã‚¹æ™‚ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šæ„å‘³ã®ã‚ã‚‹çµæœã‚’è¿”å´ã™ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã«ç€ç›®ã—ã¦ä¸‹è¨˜ã«ã¤ã„ã¦è©±ã—ã¾ã™
    - Rubyã‚’è¨˜è¿°ã™ã‚‹éš›ã®é–‹ç™ºè€…ä½“é¨“ãŒã©ã‚Œãã‚‰ã„å‘ä¸Šã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
    - ã€Œå¯èƒ½ãªé™ã‚Šã„ã‚‚ã®ã‚ã‚‹çµæœã€ã‚’ã©ã†ã‚„ã£ã¦çµ„ã¿ç«‹ã¦ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã‚¦ã‚©ãƒ³ãƒ†ãƒƒãƒ‰ãƒªãƒ¼ã§æ¨è–¦åŸºç›¤ã®æ”¹å–„ã‚’ã‚„ã£ã¦ã„ã‚‹[nasa](https://twitter.com/nasa_desu)ã§ã™ã€‚

å»å¹´ã‚‚Rubyã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚µãƒ³ã‚¿ã•ã‚“ã‹ã‚‰å±Šãã¾ã—ãŸã€‚https://www.ruby-lang.org/ja/news/2023/12/25/ruby-3-3-0-released/
Ruby 3.3ã§ã¯Prismã¨ã„ã†æ–°ã—ã„ãƒ‘ãƒ¼ã‚µãƒ¼ãŒå®Ÿé¨“çš„ã«å°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚

Prismã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ãŒ`ruby --parser=prism`ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ä½¿ãˆã‚‹çŠ¶æ…‹ã§ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆgemã¨ã—ã¦ã‚‚å°å…¥ã•ã‚Œã¦ã„ã‚‹ã®ã§ä¸‹è¨˜ã®ã‚ˆã†ãªRubyãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§è©¦ã™ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

```ruby
require "prism"

source = <<~RUBY
def foo
  puts "foo"
end
RUBY

result = Prism.parse(source)
```


æœ¬è¨˜äº‹ã§ã¯Prismã®ã€Œãƒ‘ãƒ¼ã‚¹æ™‚ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šæ„å‘³ã®ã‚ã‚‹çµæœã‚’è¿”å´ã™ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã«ã¤ã„ã¦åƒ•ã®ç–‘å•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## Prismã®ç‰¹å¾´

æ–°ã—ã„ãƒ‘ãƒ¼ã‚µãƒ¼ã¨ã„ã†ã“ã¨ã§ã¾ãšã¯Prismã®æ¦‚è¦ã‚’è¿°ã¹ã¦ãŠãã¾ã™ã€‚æœ¬é¡Œã«æ—©ãå…¥ã‚ŠãŸã„äººã¯é©å½“ã«èª­ã¿é£›ã°ã—ã¦ä¸‹ã•ã„ãƒ¼

Prismã¯ä¸»ã«ShopifyãŒé–‹ç™ºã—ã¦ã„ã‚‹æ–°ã—ã„Rubyãƒ‘ãƒ¼ã‚µãƒ¼ã§ã™ã€‚
ç¾æ™‚ç‚¹ã®Rubyã®æ§‹æ–‡ã¯100%ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ã®ã¨Shopifyãªã©è¤‡æ•°ã®å¤§è¦æ¨¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å‹•ä½œç¢ºèªã‚’è¡Œã„ã€å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¦ã„ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚ˆã†ã§ã™ã€‚

Prismã¯ä¸‹è¨˜ã®3ã¤ãŒé–‹ç™ºã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãªã£ã¦ã„ã¾ã™ã€‚

- ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆ
- ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§

ãã‚Œãã‚Œå°‘ã—è©³ã—ãæ›¸ã„ã¦ã„ãã¾ã™ã­ã€‚

### ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆ

ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã¯ãã®åã®é€šã‚Šã€ãƒ‘ãƒ¼ã‚µãƒ¼ã§ä½•ã‹å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šæ„å‘³ã®ã‚ã‚‹çµæœã‚’è¿”å´ã™ã‚‹ã“ã¨ã§ã™ã€‚

ãƒ‘ãƒ¼ã‚µãƒ¼ã®ä¸»ãªè²¬å‹™ã¯ASTã‚’çµ„ã¿ç«‹ã¦ã‚‹ã“ã¨ã§ã™ãŒã€LSPã®ã‚ˆã†ãªå®Ÿè£…é€”ä¸­ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ‰±ã†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«é–¢ã—ã¦ã¯ãŸã ASTã‚’çµ„ã¿ç«‹ã¦ã‚‹ã ã‘ã§ã¯ä¸ååˆ†ã§ã™ã€‚
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒçµ¶ãˆé–“ãªãå¤‰åŒ–ã™ã‚‹çŠ¶æ³ã§é–‹ç™ºè€…ã«ã¨ã£ã¦æœ‰ç›Šãªæƒ…å ±ã‚’è¿”ã™ã“ã¨ãŒæœ›ã¾ã‚Œã¾ã™ã€‚

### ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£

ç¾çŠ¶ã®Rubyã®ãƒ‘ãƒ¼ã‚µãƒ¼ã¯CRuby, JRuby, TruffleRubyã¨ã„ã£ãŸRubyå‡¦ç†ç³»ã€sorbet, steep, ruby-lspãªã©ã®é–‹ç™ºãƒ„ãƒ¼ãƒ«ãªã©å¤šãã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
Prismã¯ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’å¿µé ­ã«å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã“ã®ã‚«ã‚ªã‚¹ã‚’æ‰“ç ´ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

### ãƒ¡ãƒ³ãƒ†ãƒŠãƒ“ãƒªãƒ†ã‚£

ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ã®çµæœã€å¤šãã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã§é•·ãä½¿ã‚ã‚Œã¦ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ãŠã‚Šçµæœã¨ã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã®é‡è¦åº¦ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã£ã¦æ„Ÿã˜ã¿ãŸã„ã§ã™ã€‚

å®Ÿéš›ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãƒ†ã‚¹ãƒˆã®æ‹¡å……ã«ã¯åŠ›ã‚’å…¥ã‚Œã¦ã„ã‚‹å°è±¡ã§ã™ã€‚

ã“ã‚Œã‚‰ãŒPrismãŒé–‹ç™ºã•ã‚ŒãŸãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚Šã¾ã™ã€‚
Prismé–‹ç™ºè€…ãŒå…¬é–‹ã—ã¦ã„ã‚‹ã“ã¡ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¦‹ã‚‹ã¨ã‚ˆã‚Šå¤šãã‚’å­¦ã¹ã‚‹ã¨æ€ã„ã¾ã™ï¼

https://speakerdeck.com/kddnewton/prism

## Prismã®å‹•ã‹ã—æ–¹

rubyã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿çµŒç”±ã§å‹•ã‹ã™ã®ã«ä¸€å·¥å¤«å¿…è¦ã ã£ãŸã®ã§ãã‚Œã‚’ç´¹ä»‹ã—ã¾ã™ã€‚(æœ¬é¡Œã˜ã‚ƒãªãã¦ã”ã‚ã‚“ãªã•ã„)

`ruby --parser=prism`ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§åˆ©ç”¨ã¯ã§ãã‚‹ã‚“ã§ã™ãŒã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã—ã¾ã†çŠ¶æ…‹ã§ã™ã€‚ã€‚ã€‚(ã“ã®ãƒã‚°ã¯3.3.1ã§ä¿®æ­£äºˆå®šã¿ãŸã„)

ãªã®ã§masterã®rubyã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ãŸã„äººã¯ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é ¼ã‚Šã«æœ€æ–°ã®Rubyã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã¦ä¸‹ã•ã„ï¼

https://docs.ruby-lang.org/en/master/contributing/building_ruby_md.html


ãã‚Œã‹ã‚‰å®Ÿã¯ã‚‚ã†ä¸€ã¤ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã®ç©ºè¡Œã®æœ‰ç„¡ã«ã‚ˆã£ã¦æŒ™å‹•ãŒå¤‰ã‚ã‚‹ãŸã‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
ç©ºè¡ŒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã¡ã‚“ã¨å‹•ã„ã¦ãã‚Œã‚‹ã‚“ã§ã™ãŒã€ç©ºè¡ŒãŒã‚ã‚‹ã¨ãƒãƒ³ã‚°ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã“ã‚Œã‚‚ãŠãã‚‰ã3.3.1ã§ä¿®æ­£ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚


### å‹•ãã‚³ãƒ¼ãƒ‰

```ruby
:) % bat main.rb
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: main.rb
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ class Foo
   2   â”‚   def initialize(
   3   â”‚     true
   4   â”‚   end
   5   â”‚
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:) % ruby --parser=prism main.rb
main.rb: syntax errors found (SyntaxError)
  1 | class Foo
> 2 |   def initialize(
    |                  ^ expected a `)` to close the parameters
  3 |     true
  4 |   end
> 5 |
    | ^ expected an `end` to close the `class` statement
    | ^ cannot parse the expression
```

### å‹•ã‹ãªã„ã‚³ãƒ¼ãƒ‰

```
:) % bat main.rb
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: main.rb
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ class Foo
   2   â”‚   def initialize(
   3   â”‚     true
   4   â”‚   end
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:) % /Users/wantedly564/lab/oss/ruby/build/ruby --parser=prism main.rb
SEGV received in BUS handler
zsh: abort      /Users/wantedly564/lab/oss/ruby/build/ruby --parser=prism main.rb
```

## Rubyã‚’è¨˜è¿°ã™ã‚‹éš›ã®é–‹ç™ºè€…ä½“é¨“ãŒã©ã‚Œãã‚‰ã„å‘ä¸Šã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

æœ¬é¡Œã§ã™ã€‚ã§ã¯Prismã®ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã«ã‚ˆã£ã¦Rubyã‚’ä½¿ç”¨ã—ãŸé–‹ç™ºä½“é¨“ãŒã©ã®ç¨‹åº¦å‘ä¸Šã™ã‚‹ã®ã‹è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

Rubyã§ã‚ˆãã‚„ã£ã¦ã—ã¾ã†æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ã„ãã¤ã‹ä¸Šã’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼ã¨Prismã¨ã§æŒ™å‹•ã®é•ã„ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

### endå¿˜ã‚Œ

ãƒã‚¹ãƒˆãŒæ·±ããªã£ãŸã¨ãã«ã‚ˆãã‚„ã£ã¦ã—ã¾ã„ã¾ã™ã€‚endãŒä¸€ã¤å¤šã„ã®ã‚‚ã‚„ã‚‹ã€‚ã€‚

```ruby
def example_method
  puts "Hello"
```

ã“ã‚Œã¯Prismã®ã»ã†ãŒå¯¾å¿œãŒå¿…è¦ãªç®‡æ‰€ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã­

| Default parser | Prism |
| --- | --- |
| ![](/images/ruby_prism_begin/r_endless.png)| ![](/images/ruby_prism_begin/p_endless.png) |

### endãŒå¤šã„

ã¨ã„ã†ã“ã¨ã§å…ˆç¨‹å‡ºãŸendãŒä¸€ã¤å¤šã„å•é¡Œ


```ruby
def example_method
  puts "Hello"
end
end
```


| Default parser | Prism |
| --- | --- |
| ![](/images/ruby_prism_begin/r_endmore.png)| ![](/images/ruby_prism_begin/p_endmore.png) |

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`unexpected end`ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ãŒã‚¨ãƒ©ãƒ¼ç®‡æ‰€æŠŠæ¡ãŒã¡ã‚‡ã£ã¨ãƒ ã‚ºã„ã€‚
Prismã®ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã¯çš„ã‚’å°„ã¦ã„ã‚‹ãŒ`cannot parse the expression`ãŒåˆ†ã‹ã‚Šã¥ã‚‰ã„

ã©ã¡ã‚‰ã‹ãŒç¢ºå®Ÿã«è‰¯ã„ã¨ã¯ã„ãˆãªã•ãã†ï¼Ÿã¾ã‚ãƒˆãƒ³ãƒˆãƒ³ã¨è¡Œã£ãŸã¨ã“ã‚ã§ã—ã‚‡ã†ã‹ã€‚


### é–‰ã˜æ‹¬å¼§å¿˜ã‚Œ

```ruby
def test(
  puts "hoge"
end

test(
```

ã©ã¡ã‚‰ã‚‚`puts`ã‚’å¼•æ•°ã¨ã—ã¦è§£é‡ˆã—ã¦`puts`ã®å¾Œã«é–‰ã˜æ‹¬å¼§ãŒå¿…è¦ã ã¨è§£é‡ˆã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚
ã“ã¡ã‚‰ã‚‚ãƒˆãƒ³ãƒˆãƒ³ã§ã™ã‹ã­ã€‚
Prismã«é–¢ã—ã¦ã¯ï¼’ã¤ç›®ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«é–¢ã—ã¦ã‚‚æ‰±ãˆã¦ã„ã‚‹ã®ã§ã“ã®ç‚¹ã¯ã‚ã¡ã‚ƒè‰¯ã„ã§ã™ã­ãƒ¼


### åŒºåˆ‡ã‚Šæ–‡å­—å¿˜ã‚Œ


```ruby
array = [1, 2, 3, 4 5]
```

ã“ã‚Œã¯PrismãŒè‰¯ã„ã§ã™ã­ãƒ¼ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æŒ‡æ‘˜ç®‡æ‰€ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã­


### å¤‰æ•°åã‚¿ã‚¤ãƒ(å­˜åœ¨ã—ãªã„å¤‰æ•°å)


```ruby
a = 1
puts aa
```

ãŠãŠï¼ã“ã‚Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼ãŒè‰¯ã„æ„Ÿã˜ã§ã™ã­ã€‚


```ruby
def test
end

test1
```

é–¢æ•°ã‚‚åŒæ§˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼ã®ãŒè‰¯ã„æ„Ÿã˜ã§ã™ã­ãƒ¼


### ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®ãƒ‰ãƒƒãƒˆã ã‘æ›¸ã„ãŸ

ã‚ã¾ã‚Šç„¡ã„ãƒŸã‚¹ã§ã™ãŒå®Ÿè£…é€”ä¸­ã«ã‚ˆãç™ºç”Ÿã™ã‚‹ã¨æ€ã†ã®ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚

```ruby
test.
```


ãŠã£ã¨ã€‚Prismã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã—ã¾ã„ã¾ã—ãŸã­ã€‚ã€‚ã€‚
PRãƒãƒ£ãƒ³ã‚¹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è€ƒæ…®ã—ã¦ãã‚Œã‚‹ã‹

ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è€ƒæ…®ã™ã‚‹ã¨ifã«å¯¾ã™ã‚‹endãŒç„¡ã„ã¨è¨€ãˆã¾ã™ã€‚ã“ã®è¾ºè€ƒæ…®ã—ã¦ãã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹


```ruby
def test
  if true
    puts "true"
end
```

ã¾ã‚äºˆæƒ³ã¯ã—ã¦ã„ã¾ã—ãŸãŒå³ã—ã„ã‚ˆã†ã§ã™ã­ã€‚ã€‚ã€‚


### ãã®ä»–

ã“ã“ã§æ‰±ã£ãŸã®ã¯ã»ã‚“ã®ä¸€éƒ¨ã ã¨æ€ã„ã¾ã™ã€‚

ãã®ä»–ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯Prismã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’çœºã‚ã¦ã¿ã¦ä¸‹ã•ã„ï¼

https://github.com/ruby/prism/blob/3f00d9f0743c948f2c1768dce4716ff499b927ce/test/prism/errors_test.rb

---



- ã‚¿ã‚¤ãƒˆãƒ«: Ruby 3.3ã§å°å…¥ã•ã‚ŒãŸPrismã‚’ä½¿ã†ã¨Rubyã‚’ä½¿ã£ãŸé–‹ç™ºä½“é¨“ãŒã©ã†å¤‰ã‚ã‚‹ã®ã‹
- Prismã¨ã¯
    - Ruby 3.3ã‹ã‚‰å°å…¥ã•ã‚ŒãŸãƒ‘ãƒ¼ã‚µãƒ¼
    - å‰èº«ã¯YARP
    - Prismã¯ä¸‹è¨˜ã‚’ç›®çš„ã¨ã—ã¦é–‹ç™ºã•ã‚Œã¦ã„ã‚‹
        - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆ
            - ãƒ‘ãƒ¼ã‚¹æ™‚ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šæ„å‘³ã®ã‚ã‚‹çµæœã‚’è¿”å´ã™ã‚‹ã“ã¨
        - ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£
            - è¤‡æ•°ã®Rubyå‡¦ç†ç³»ã€å‹ãƒã‚§ãƒƒã‚«ãƒ¼ã€lspãªã©ãã‚Œãã‚Œã«ãƒ‘ãƒ¼ã‚µãƒ¼ãŒå­˜åœ¨ã—ã¦ã„ã‚‹çŠ¶æ…‹
            - ã“ã‚Œã‚‰ã‚’1ã¤ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã§ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„
        - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§
            - ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ã®çµæœã€å¤šãã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã§é•·ãä½¿ã‚ã‚Œã¦ã‚‹
            - çµæœã¨ã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã®é‡è¦åº¦ãŒä¸ŠãŒã£ã¦ã„ã‚‹
- æœ¬è¨˜äº‹ã§ã¯ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã«ã¤ã„ã¦æ‰±ã†
    - Rubyãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–‹ç™ºä½“é¨“ã«æœ€ã‚‚å½±éŸ¿ã‚’ä¸ãˆã‚‹ã®ã¯ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã ã¨æ€ã‚ã‚Œã‚‹
        - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å½±éŸ¿ã‚‚0ã§ã¯ãªã„ãŒåƒ•è‡ªèº«èª²é¡Œã«æ„Ÿã˜ãŸã“ã¨ã¯ãªã„ãŸã‚çœç•¥
    - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ©ãƒ³ãƒˆã¨ã¯
- å‹•ã‹ã—æ–¹
    - `--parser=prism`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§è©¦ã™ã“ã¨ãŒå‡ºæ¥ã‚‹
    - ãã®ã¯ãšã ã£ãŸã®ã ãŒã€æœ€æ–°ã®Ruby 3.3.0ã§ã¯æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸéš›ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹
    - Rubyã®masterãƒ–ãƒ©ãƒ³ãƒã§å‹•ä½œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹(minirubyã§ã‚‚å¯èƒ½)
- Rubyã§ã‚ˆãã‚ã‚‹æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«å¯¾ã—ã¦ã©ã®ç¨‹åº¦å¯¾å¿œã§ãã‚‹ã®ã‹
    - [x] endã‚’æ¼ã‚‰ã—ãŸ
    - [x] é–‰ã˜ã‚«ãƒƒã‚³
    - [x] é…åˆ—ã€ãƒãƒƒã‚·ãƒ¥ã®é–‰ã˜ã‚«ãƒƒã‚³
    - [x] é…åˆ—ã€ãƒãƒƒã‚·ãƒ¥ã®åŒºåˆ‡ã‚Šæ–‡å­—
    - [x] å­˜åœ¨ã—ãªã„å¤‰æ•°ã€ãƒ¡ã‚½ãƒƒãƒ‰
    - [x] ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®ãƒ‰ãƒƒãƒˆã ã‘æ›¸ã„ãŸ
    - [ ] ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¦‹ã¦ã„ã‚‹ã®ã‹
    - [ ] è¤‡æ•°ã‚¨ãƒ©ãƒ¼
- ã“ã‚Œã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã©ã®ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã‹


## endå¿˜ã‚Œ

<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
Unmatched keyword, missing `end' ?
> 1  def example_method

test.rb:5: syntax error, unexpected end-of-input, expecting `end' or dummy end (SyntaxError)
```

</td>
<td>

```sh
test.rb: syntax errors found (SyntaxError)
  3 |     puts "Hello"
  4 |   end
> 5 |
    | ^ expected an `end` to close the `def` statement
    | ^ cannot parse the expression
```

</td>
</tr>
</table>


## endãŒå¤šã„

<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
Unmatched `end', missing keyword (`do', `def`, `if`, etc.) ?
> 1  def example_method
> 3  end
> 4  end

test.rb:4: syntax error, unexpected `end' (SyntaxError)
```

</td>
<td>

```sh
test.rb: syntax errors found (SyntaxError)
  2 |   puts "Hello"
  3 | end
> 4 | end
    | ^ cannot parse the expression
```

</td>
</tr>
</table>


## é–‰ã˜æ‹¬å¼§å¿˜ã‚Œ

<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
Unmatched `(', missing `)' ?
> 1  def test(
> 3  end
> 5  test(

test.rb:2: syntax error, unexpected string literal, expecting ')' (SyntaxError)
  puts "test"
       ^
```

</td>
<td>

```sh
test.rb: syntax errors found (SyntaxError)
  1 | def test(
> 2 |   puts "test"
    |       ^ expected a `)` to close the parameters
  3 | end
  4 |
> 5 | test(
    |      ^ expected a `)` to close the arguments
  6 |
```

</td>
</tr>
</table>

## åŒºåˆ‡ã‚Šæ–‡å­—

<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
expected a `,` separator for the array elements
> 1  array = [1, 2, 3, 4 5]

test.rb:1: syntax error, unexpected integer literal, expecting ']' (SyntaxError)
array = [1, 2, 3, 4 5]
```

</td>
<td>

```sh
test.rb: syntax errors found (SyntaxError)
> 1 | array = [1, 2, 3, 4 5]
    |                    ^ expected a `,` separator for the array elements
```

</td>
</tr>
</table>


## å­˜åœ¨ã—ãªã„å¤‰æ•°


<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
test.rb:2:in `<main>': undefined local variable or method `aa' for main (NameError)

puts aa
     ^^
Did you mean?  a
```

</td>
<td>

```sh
/Users/wantedly564/lab/sandbox/ruby_sandobx/test.rb:1:in `<compiled>': undefined local variable or method `aa' for main (NameError)
```

</td>
</tr>
</table>

## å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰

<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
test.rb:4:in `<main>': undefined local variable or method `test1' for main (NameError)

test1
^^^^^
Did you mean?  test
```

</td>
<td>

```sh
/Users/wantedly564/lab/sandbox/ruby_sandobx/test.rb:3:in `<compiled>': undefined local variable or method `test1' for main (NameError)
```

</td>
</tr>
</table>



## å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹


<table>
<tr>
<td> Status </td> <td> Response </td>
</tr>
<tr>
<td>

```sh
:) % bat main.rb
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: main.rb
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ class Foo
   2   â”‚   def initialize(
   3   â”‚     true
   4   â”‚   end
   5   â”‚
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:) % ruby --parser=prism main.rb
main.rb: syntax errors found (SyntaxError)
  1 | class Foo
> 2 |   def initialize(
    |                  ^ expected a `)` to close the parameters
  3 |     true
  4 |   end
> 5 |
    | ^ expected an `end` to close the `class` statement
    | ^ cannot parse the expression
```

</td>
<td>

```
:) % bat main.rb
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: main.rb
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ class Foo
   2   â”‚   def initialize(
   3   â”‚     true
   4   â”‚   end
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

:) % /Users/wantedly564/lab/oss/ruby/build/ruby --parser=prism main.rb
SEGV received in BUS handler
zsh: abort      /Users/wantedly564/lab/oss/ruby/build/ruby --parser=prism main.rb
```

</td>
</tr>
</table>

### ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®ãƒ‰ãƒƒãƒˆã ã‘æ›¸ã„ãŸ


<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
expected a method name
> 1  test.
> 2
```

</td>
<td>

```sh
ruby 3.4.0dev (2024-01-19T11:02:59Z master 7b0f6d6d94) +PRISM [arm64-darwin22]

-- Crash Report log information --------------------------------------------
   See Crash Report log file in one of the following locations:
     * ~/Library/Logs/DiagnosticReports
     * /Library/Logs/DiagnosticReports
   for more details.
Don't forget to include the above Crash Report log file in bug reports.
```

</td>
</tr>
</table>

### ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ


<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
Unmatched keyword, missing `end' ?
> 1  def test
> 2    if true
> 4  end

test.rb:5: syntax error, unexpected end-of-input, expecting `end' or dummy end (SyntaxError)
```

</td>
<td>

```sh
test.rb: syntax errors found (SyntaxError)
  3 |     puts "true"
  4 | end
> 5 |
    | ^ expected an `end` to close the `def` statement
    | ^ cannot parse the expression
```

</td>
</tr>
</table>

---



<table>
<tr>
<td> default parser </td> <td> Prism </td>
</tr>
<tr>
<td>

```sh
```

</td>
<td>

```sh
```

</td>
</tr>
</table>
